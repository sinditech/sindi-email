# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path
name: Sindi Email - Publish

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip running tests before deploy?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
    

jobs:
  publish:
    # if: github.event.pull_request.merged == true
    name: Release on MavenCentral
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating a release if you automate that part
      packages: write # Needed if you also push to GitHub Packages

    steps:
      - name: Step 1 - Checkout code
        uses: actions/checkout@v4

      - name: Step 2 - Set up Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17' # Or your desired Java version
          distribution: 'temurin'
          cache: 'maven'
          # Important: This configures settings.xml for you
          # It looks for the server ID 'central' by default
          # and uses MAVEN_USERNAME/MAVEN_PASSWORD environment variables
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
      - run: |
          git config --global user.name 'Buhake Sindi'
          git config --global user.email 'buhake@gmail.com'

      - name: Step 3 - Import GPG secret key
        run: |
          cat <(echo -e "${{ secrets.MAVEN_GPG_PRIVATE_KEY }}") | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG
        env:
          MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}

      - name: Step 4 - Get latest tag
        id: latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Step 5 - Generate changelog from commits
        id: changelog
        run: |
          VERSION=${{ github.event.inputs.version }}
          LATEST_TAG=${{ steps.latest_tag.outputs.latest_tag }}
          
          # Get commits since last tag or all commits if no tag exists
          if [ -z "$LATEST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          if [ -z "$COMMITS" ]; then
            echo "No new commits found for changelog"
            exit 1
          fi
          
          # Create changelog entry
          CHANGELOG_ENTRY="## [$VERSION] - $(date +%Y-%m-%d)\n$COMMITS\n"
          
          echo "$CHANGELOG_ENTRY" > new_changelog.txt
          
          # Save for GitHub output (truncate if too long)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_ENTRY" | head -c 4000 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Step 6 - Update CHANGELOG.md
        run: |
          VERSION=${{ github.event.inputs.version }}
          
          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi
          
          # Prepend new changelog entry after the header
          {
            # Keep the header (first 4 lines or until first ##)
            awk '/^## / {exit} {print}' CHANGELOG.md
            echo ""
            cat new_changelog.txt
            echo ""
            # Append existing releases
            awk '/^## / {found=1} found {print}' CHANGELOG.md
          } > CHANGELOG.md.new
          
          mv CHANGELOG.md.new CHANGELOG.md
          
          # Show the updated changelog
          echo "Updated CHANGELOG.md:"
          head -n 20 CHANGELOG.md

      - name: Step 7 - Set release version
        run: mvn versions:set -DnewVersion=${{ github.event.inputs.release_version }} -DgenerateBackupPoms=false

      - name: Step 8 - Confirm version
        run: mvn help:evaluate -Dexpression=project.version -q -DforceStdout

      - name: Step 9 - Commit changelog and version changes
        run: |
          git add CHANGELOG.md pom.xml
          git commit -m "chore: release version ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push 

      - name: Step 10 - Publish package
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" == "true" ]; then
            mvn --batch-mode deploy -DskipTests -DskipITs -Dspotless.check.skip=true -Psign -e # -P release if you use a profile for release builds
          else
            mvn clean verify deploy -P release -B -U --no-transfer-progress
          fi
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }} # Passed to the GPG plugin

      - name: Step 11 - Create Git tag for release
        run: |
          VERSION=${{ github.event.inputs.release_version }}
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"
          
      - name: Step 12 - Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.release_version }}
          name: Release v${{ github.event.inputs.release_version }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
